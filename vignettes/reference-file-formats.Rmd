---
title: "Reference table file formats"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reference table file formats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

These are the column headers for CSV-formatted reference table files.
`harsat` uses three different reference tables: 

1. A species file
2. A determinand file
3. A thresholds file 

All these files should be in your information files directory.

## Species file format

The species file will be `species.csv` in your information files directory.

| column name   | type      | mandatory | comments              |
| ------------- | --------- | :-------: | --------------------- |
| `reference_species` | character | yes | Reference species name (usually its Latin name) |
| `submitted_species` | character | yes | Submitted species name: sometimes the same species can have several Latin names, but these are all mapped to the Reference species name |
| `common_name` | character | yes | Common name for the species: you can call them whatever you want |
| `species_group` | character | yes | Species group, should be one of: `Bird`, `Bivalve`, `Crustacean`, `Echinoderm`, `Fish`, `Gastropod`, `Macrophyte`, `Mammal`, `Other` |
| `species_subgroup` | character | yes | This is a convenience column used for matching species to thresholds. For example, OSPAR sometimes has different thresholds for mussels and oysters, so these form convenient subgroups. You can call things what you want, provided they match any reference to the species_subgroup column in the thresholds file. If you don't need this facility, just use the `species_group` value |
| `assess` | boolean | yes | Whether or not to include this species in the assessment, should be either `TRUE` or `FALSE` |
| `MU_drywt` | numeric | no | Muscle dry weight (%). A typical value for the species. This is only needed if you want to convert thresholds from one basis to another. Leave cells blank if you do not have a suitable value. |
| `LI_drywt` | numeric | no | Liver dry weight (%)|
| `SB_drywt` | numeric | no | Soft body dry weight (%)|
| `EH_drywt` | numeric | no | Egg homogenate dry weight (%) |
| `MU_lipidwt` | numeric | no | Muscle lipid weight (%) |
| `LI_lipidwt` | numeric | no | Liver lipid weight (%)|
| `SB_lipidwt` | numeric | no | Soft body lipid weight (%) |
| `EH_lipidwt` | numeric | no | Egg homogenate lipid weight (%) |

You can have as many dry and lipid weight columns as you have tissue types.  For example, if you have blood (BL) data, then you can have columns BL_drywt and BL_lipidwt.  (Remember there is a difference between BL (blood) and ER (erythrocytes - red blood cells in vertebrates).



## Determinand file format

The determinand file will be `determinand.csv` in your information files directory.

| column name   | type      | mandatory | comments              |
| ------------- | --------- | :-------: | --------------------- |
| `determinand` | character | yes | Determinant code -- this is a key to the thresholds file records and will usually be the ICES PARAM code |
| `common_name` | character | yes | Common name for the determinant, e.g., `Aluminium`, `Glyphosate`. You can leave this blank, in which case the determinand code is used.  |
| `pargroup` | character | yes | ICES parameter group reference code, e.g. `I-MET`, `O-PAH`, `OC-CB`, `OC-DD`, etc. (see: https://vocab.ices.dk/?ref=78) |
| `biota_group` | character | yes (biota assessment) | Grouping for a biota assessment (under development): currently one of `Metals`, `PAH_parent`, `PAH_alkylated`, `Chlorobiphenyls`, `PBDEs`, `Organobromines`, `Organotins`, `Organochlorines`, `Organofluorines`, `Pesticides`, `Dioxins`, `Effects`, `Auxiliary`, `Metabolites`, or `Imposex` |
| `sediment_group` | character | yes (sediment assessment) | Grouping for a sediment assessment. See biota_group for allowable values. Note that normalisers, such as AL or CORG, should be classed as `Auxiliary` |
| `water_group` | character | yes (water assessment) | Grouping for a water assessment. See biota_group for allowable values |
| `biota_assess` | boolean | yes (biota assessment) | Whether the determinand is to be assessed: should be either `TRUE` or `FALSE`. For the time being, 'Auxiliary' determinands must be set to 'FALSE' |
| `sediment_assess` | boolean | yes (sedimenet assessment) | Whether the determinand is to be assessed. See biota_assess for more details |
| `water_assess` | boolean | yes (water assessment) | Whether the determinand is to be assessed. See biota_assess for more details |
| `biota_unit` | character | yes (biota assessment) | The unit that all measurements will be converted to in a biota assessment; e.g. `ug/kg` |
| `sediment_unit` | character | yes (sediment assessment) | The unit that all measurements will be converted to in a sediment assessment; e.g. `mg/kg` |
| `water_unit` | character | yes (water assessment)| The unit that all measurements will be converted to in a water assessment, e.g. `ug/l` |
| `biota_auxiliary` | character | yes (biota assessment) | Identifies all the auxiliary measurements that should be associated with the determinand. These should be separated by a `~`. For example, for chemical contaminants, this might be 'DRYWT%~LIPIDWT%~LNMEA'. The list gets more interesting for effects measurements. |
| `sediment_auxiliary` | character | yes (sediment assessment) | Identifies all the auxiliary measurements that should be associated with the determinand. These should be separated by a `~`. For example, for metal contaminants, this might be 'AL~LI~CORG' |
| `water_auxiliary` | character | yes (water assessment) | Identifies all the auxiliary measurements that should be associated with the determinand. These should be separated by a `~`. Not currently used much for water assessments |
| `biota_sd_constant` | character | no | If supplied, this allows the imputation of measurement uncertainty for determinands in a biota assessment. 'sd_constant' is the constant error with units given by 'biota_unit' |
| `biota_sd_variable` | character | no | If supplied, this allows the imputation of measurement uncertainty for determinands in a biota assessment. 'sd_constant' is the proportional error expressed as a percentage (%) |
| `sediment_sd_constant` | character | no | See 'biota_sd_constant' |
| `sediment_sd_variable` | character | no | See 'biota_sd_variable' |
| `water_sd_constant` | character | no | See 'biota_sd_constant' |
| `water_sd_variable` | character | no | See 'biota_sd_variable' |
| `distribution` | character | yes | A distribution type; for chemical contaminants, this should be set to `lognormal`. Only required for determinands where at least one of 'biota_assess', 'sediment_assess' or 'water_assess' are 'TRUE' |
| `good_status` | character | yes | Whether 'high' or 'low' values of the determinand indicates a healthy environment. Only required for determinands where at least one of 'biota_assess', 'sediment_assess' or 'water_assess' are 'TRUE' |

## Thresholds file format

The thresholds files (there are usually several, one for each compartment) might vary
considerably between the compartments. However, the principle is the same: they 
set values for some given determinand. In the case of biota, that's linked to a
particular species or species group. In the case of sediment, it is linked, typically,
to a region. Water is the simplest, so let's look at that first:

### Water thresholds files

A water thresholds file will be `thresholds_water.csv` in your information files directory. For illustration, suppose we have just one threshold, the EQS. The thresholds file will then have the following four columns:

| column name   | type      | mandatory | comments              |
| ------------- | --------- | :-------: | --------------------- |
| `determinand` | character | yes | The determinand code, which must key to the determinand file |
| `filtration` | character | yes | A string, either `filtered` or `unfiltered`. Missing values not allowed. |
| `EQS_basis` | character | no | The basis on which the EQS is expressed: for water this will always be `W`. The basis must always be given if there is an EQS value in the next column. |
| `EQS` | numeric | no | The value of the EQS. The units must key to the water_units column in the determinand file |

If there is another threshold, for example, the BAC, then add two columns called `BAC_basis` and `BAC`. You can have as many thresholds as you want. 

If, for a particular determinand, the same (set of) threshold value(s) is to be applied to both `filtered` and `unfiltered` time series, then set `filtration` to `filtered~unfiltered`.



### Sediment thresholds files

A sediment thresholds file will be `thresholds_sediment.csv` in your information files directory. For illustratoin, suppose we have two thresholds, the BAC and EAC. The thresholds file will then have the following five columns:

| column name   | type      | mandatory | comments              |
| ------------- | --------- | :-------: | --------------------- |
| `determinand` | character | yes | The determinand code, which must key to the determinands file |
| `BAC_basis` | character | no | The basis on which the BAC is expressed: for sediment this will typically be `D`, but it could also be `W`. This must always be provided if there is a BAC value. |
| `EAC_basis` | character | no | The basis on which the EAC is expressed. See above. |
| `BAC` | character | no | The value of the BAC. The units much key to the sediment_units column in the determinand file. The units are also assumed to be normalised for grain size in the same way as the data are normalised (in create_timeseries).  |
| `EAC` | character | no | The value of the EAC. See above. |

Again, you can have as many thresholds as you want. For example, OSPAR assessments typically use the ERL, EQS and FEQG in addition to the BAC and EAC.

You can also have extra columns which match columns in the station dictionary. Typically, these will be used to apply different threshold values to different regions. For example, the OSPAR thresholds file has a column `ospar_subregion`, which allows one set of threshold values to be applied in the Iberian Coast and Gulf of Cadiz and another set in the rest of the OSPAR area. 



### Biota thresholds files

A biota thresholds file will be `thresholds_biota.csv` in your information files directory.

| column name   | type      | mandatory | comments              |
| ------------- | --------- | :-------: | --------------------- |
| `determinand` | character | yes | The determinand code, which must key to the determinands file |
| `species_group` | character | no | The species group, a key to the `species.csv` file |
| `species_subgroup` | character | no | The species subgroup, a key to the `species.csv` file |
| `species` | character | no | The species, a key to the `species.csv` file (and specifically the `reference_species` column) |
| `matrix` | character | yes | A selection expression: a tilde `~` separated set of determinand combinations, which may be a single determinand or a combination joined by ampersands |
| `BAC_basis` | character | no | The threshold basis for BAC, either `D` or `W` |
| `MPC_basis` | character | no | The threshold basis for MPC, either `D` or `W` |
| `EQS_basis` | character | no | The threshold basis for EQS, either `D` or `W` |
| `EAC_basis` | character | no | The threshold basis for EAC, either `D` or `W` |
| `BAC` | character | no | The BAC threshold value |
| `MPC` | character | no | The MPC threshold value |
| `EQS` | character | no | The EQS threshold value |
| `EAC` | character | no | The EAC threshold value |

Note that while none of the `species_group`, `species_subgroup`, and `species` are themselves
mandatory, in each row, there needs to be enough to match to the species lists. They cannot 
all be unspecified. 
